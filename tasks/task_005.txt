# Task ID: 5
# Title: Implement Teams Phone Integration
# Status: pending
# Dependencies: 3
# Priority: medium
# Description: Enable outbound PSTN calling to clients directly from the portal using Teams Phone System, with call logging functionality.
# Details:
1. Create tRPC `phoneRouter` with procedures: `makePstnCall`, `logCall`
2. Configure Graph API permissions: `Calls.Initiate.All`
3. Create database schema for call logs (callerId, clientId, contactId, numberDialed, startTime, endTime, duration)
4. Implement `/phone` page with client/contact search functionality
5. Add call buttons next to contacts with phone numbers
6. Create Admin-only dial pad UI for direct number entry
7. Implement call logging after call initiation
8. Add role-based visibility controls for phone features

# Test Strategy:
1. Verify PSTN calls can be initiated from contact list
2. Test Admin dial pad functionality
3. Confirm call logs are correctly created and stored
4. Validate RBAC for phone features
5. Test error handling for failed calls

# Subtasks:
## 1. Set Up Teams Phone System Integration and Permissions [done]
### Dependencies: None
### Description: Configure Microsoft Teams Phone System for outbound PSTN calling, including necessary Microsoft Graph API permissions and external provisioning by QAS IT.
### Details:
Coordinate with QAS IT to provision Teams Phone System licenses, phone numbers, and calling plans. Configure the Microsoft Graph API with the 'Calls.Initiate.All' permission to allow programmatic call initiation from the portal. Validate connectivity and permissions by testing API access for outbound calls.

## 2. Design and Implement Call Logging Database Schema [done]
### Dependencies: 5.1
### Description: Create a robust database schema to store call logs, capturing all relevant call metadata.
### Details:
Define and migrate a database schema for call logs with fields: callerId, clientId, contactId, numberDialed, startTime, endTime, and duration. Ensure indexing for efficient querying and consider audit/compliance requirements for call records.

## 3. Develop tRPC phoneRouter with Call and Logging Procedures [done]
### Dependencies: 5.2
### Description: Implement a tRPC router exposing procedures for initiating PSTN calls and logging call details.
### Details:
Create a tRPC router named 'phoneRouter' with procedures: 'makePstnCall' (to initiate outbound calls via Teams Phone System using the Graph API) and 'logCall' (to record call details in the database). Ensure error handling, input validation, and secure access controls for these endpoints.

## 4. Build Portal UI for Calling and Call Management [pending]
### Dependencies: 5.3
### Description: Implement the /phone page with client/contact search, call buttons, and an admin-only dial pad for direct number entry.
### Details:
Develop the /phone page UI to allow users to search for clients/contacts, display contacts with phone numbers, and show call buttons next to each. Add an admin-only dial pad component for direct number entry. Integrate UI actions with the tRPC procedures for call initiation and logging.

## 5. Implement Call Logging and Role-Based Feature Controls [pending]
### Dependencies: 5.4
### Description: Ensure all calls are logged after initiation and restrict phone features based on user roles.
### Details:
After each call is initiated, automatically invoke the 'logCall' procedure to record the call. Implement role-based visibility and access controls for phone features (e.g., dial pad, call buttons) so only authorized users can access specific functionalities. Test to ensure compliance with security and audit requirements.

